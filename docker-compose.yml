version: '3.8'

services:
  # 3x-ui - Веб-панель управления Xray
  # Официальный образ: https://github.com/MHSanaei/3x-ui
  3x-ui:
    image: ghcr.io/mhsanaei/3x-ui:latest
    container_name: 3x-ui
    restart: unless-stopped
    network_mode: host
    environment:
      # Язык интерфейса
      - XRAY_VMESS_AEAD_FORCED=false
      # Часовой пояс
      - TZ=${TZ:-Europe/Moscow}
      # Уровень логирования
      - LOG_LEVEL=${LOG_LEVEL:-info}
    volumes:
      # База данных и конфигурация
      - ./data/db:/etc/x-ui
      # Логи
      - ./data/logs:/var/log/3x-ui
      # Сертификаты SSL (если нужны)
      - ./data/cert:/root/cert
    labels:
      - "com.docker.compose.project=reer-vpn"
      # Включить автообновления через Watchtower
      - "com.centurylinklabs.watchtower.enable=true"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${PANEL_PORT:-54321}"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    # Порты (используется host mode, но для справки):
    # ${PANEL_PORT:-54321} - Web панель управления
    # ${VLESS_PORT:-443} - VLESS Reality
    # ${VMESS_PORT:-2053} - VMess WebSocket
    # 80 - HTTP (опционально)

  # Watchtower - автоматическое обновление контейнеров
  watchtower:
    image: containrrr/watchtower:latest
    container_name: reer-watchtower
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      # Проверять обновления
      - WATCHTOWER_POLL_INTERVAL=${UPDATE_INTERVAL:-86400}
      # Очищать старые образы
      - WATCHTOWER_CLEANUP=${WATCHTOWER_CLEANUP:-true}
      # Уведомления (опционально)
      - WATCHTOWER_NOTIFICATIONS=${WATCHTOWER_NOTIFICATIONS:-}
      - WATCHTOWER_NOTIFICATION_URL=${WATCHTOWER_NOTIFICATION_URL:-}
      # Следить только за контейнерами с меткой
      - WATCHTOWER_LABEL_ENABLE=true
      # Часовой пояс
      - TZ=${TZ:-Europe/Moscow}
    labels:
      - "com.docker.compose.project=reer-vpn"
    profiles:
      - ${WATCHTOWER_ENABLED:-enabled}

networks:
  default:
    name: reer-network
