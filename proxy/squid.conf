# Минимальный Squid-конфиг для HTTP(S) прокси под API

# Порт, на котором Squid слушает запросы прокси
http_port 3128

# ==== ОГРАНИЧЕНИЕ ДОСТУПА ПО IP ====
# Разрешённые клиенты (подставь реальные IP)
# IP твоего российского сервера(ов):
acl allowed_clients src RU_SERVER_IP_1/32
#acl allowed_clients src RU_SERVER_IP_2/32   # <- если понадобится второй, раскомментируешь и поменяешь IP

# Разрешаем также локальные запросы с самого RackNerd:
acl allowed_local src 127.0.0.1/32
acl allowed_racknerd src 172.245.225.24/32

# Общая ACL: все разрешённые
acl allowed_all src RU_SERVER_IP_1/32 127.0.0.1/32 172.245.225.24/32
# Если нужно добавить ещё IP, просто допиши:
# acl allowed_all src RU_SERVER_IP_1/32 RU_SERVER_IP_2/32 127.0.0.1/32 172.245.225.24/32

# Разрешаем только этим клиентам
http_access allow allowed_all

# ==== HTTPS CONNECT (для API) ====
acl SSL_ports port 443
acl CONNECT method CONNECT

# Разрешаем HTTPS-туннель только от разрешённых клиентов
http_access allow allowed_all CONNECT SSL_ports

# Всё остальное запрещаем
http_access deny all

# ==== КЭШ ====
# Минимальный cache_dir (нужен Squid, даже если кэш отключён)
cache_dir ufs /var/spool/squid 100 16 256

# Отключаем кэширование для API-запросов
cache deny all

# ==== ЛОГИ ====
access_log /var/log/squid/access.log squid
cache_log /var/log/squid/cache.log

# ==== ЛИМИТЫ И ТАЙМАУТЫ ====
maximum_object_size_in_memory 512 KB
request_body_max_size 100 MB
reply_body_max_size 100 MB
max_filedescriptors 65536

connect_timeout 30 seconds
read_timeout 180 seconds
request_timeout 60 seconds
