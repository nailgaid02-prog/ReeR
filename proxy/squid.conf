# Squid Proxy Configuration
# Optimized for high load API requests (OpenAI, Claude, etc.)

# HTTP порт для прокси
http_port 3128

# Максимальное количество клиентских соединений
# Для 100+ параллельных запросов
workers 4
cpu_affinity_map process_numbers=1,2,3,4 cores=1,2,3,4

# Лимиты соединений
http_access allow all

# Разрешить CONNECT для HTTPS (для OpenAI API)
acl SSL_ports port 443
acl CONNECT method CONNECT
http_access allow CONNECT SSL_ports

# Кэширование отключено (для API запросов)
cache deny all

# Логирование
access_log stdio:/dev/stdout combined
cache_log /dev/null
cache_store_log stdio:/dev/stdout

# Таймауты оптимизированы для API
connect_timeout 30 seconds
read_timeout 180 seconds
request_timeout 60 seconds

# Размер объектов в памяти (для производительности)
maximum_object_size_in_memory 512 KB

# Оптимизация производительности
pipeline_prefetch on
half_closed_clients off

# DNS кэширование
positive_dns_ttl 6 hours
negative_dns_ttl 1 minute

# Форвардинг оригинальных заголовков
forwarded_for on
via off

# Аутентификация (опционально, раскомментируйте если нужна)
# auth_param basic program /usr/lib/squid/basic_ncsa_auth /etc/squid/passwords
# auth_param basic realm Proxy Authentication
# acl authenticated proxy_auth REQUIRED
# http_access allow authenticated
# http_access deny all

# Максимальный размер запроса/ответа (для больших API ответов)
request_body_max_size 100 MB
reply_body_max_size 100 MB

# Оптимизация для большого количества соединений
max_filedescriptors 65536
